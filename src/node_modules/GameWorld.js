var THREE = require('three');
var defaults = require('lodash.defaults');

var TestSphere = require('meshes/TestSphere');
var Sky = require('gameObjects/Sky');
var onVR = require('utils/devices/onVR');
var onDayDream = require('utils/devices/onDayDream');
var FirstPersonCamera = require('cameras/FirstPerson');
var FireLight = require('lights/Fire');
var ThirdPersonCamera = require('cameras/ThirdPerson');
var getColliderMaterial = require('materials/getColliderMaterial');

var addTestGeometry = require('tests/addTestGeometry');
var CarvableTetrahedron = require('gameObjects/CarvableTetrahedron');

var DynamicTextureManager = require('textures/DynamicTextureManager');

const MagicWindowRayLauncher = require('input/rayLaunchers/MagicWindow');
const DayDreamControllerRayLauncher = require('input/rayLaunchers/DayDreamController');
const CardboardRayLauncher = require('input/rayLaunchers/Cardboard');

var __defaultParams = {
};

function GameWorld(params) {
	params = defaults(params, __defaultParams);
	if(!params.scene) throw new Error('Missing a threejs scene.');
	var app = params.app;
	var scene = params.scene;
	var renderer = params.renderer;
	var rayEvents = params.rayEvents;

	this.dynamicTextureManager = new DynamicTextureManager({
		renderer: renderer
	});

	var material = new THREE.MeshStandardMaterial({
		map: this.dynamicTextureManager.maps.map.texture,
		normalMap: this.dynamicTextureManager.maps.normalMap.texture,
		emissive: 0xffffff,
		emissiveMap: this.dynamicTextureManager.maps.emissiveMap.texture,
		subSurfaceAbsorbColorMap: this.dynamicTextureManager.maps.subSurfaceAbsorbColorMap.texture,
		metalnessMap: this.dynamicTextureManager.maps.metalnessMap.texture,
		roughnessMap: this.dynamicTextureManager.maps.roughnessMap.texture,
		// aoMap: this.dynamicTextureManager.maps.aoMap,
		// alphaMap: this.dynamicTextureManager.maps.alphaMap.texture,	
		// alphaTest: 0.5,
		// transparent: true,
		// side: THREE.DoubleSide
	});

	addTestGeometry({
		scene: scene,
		material: material
	});

	var groundCollider = new THREE.Mesh(new THREE.PlaneGeometry(80, 80, 8, 8), getColliderMaterial());
	groundCollider.position.y = 0.05;
	groundCollider.rotation.x = Math.PI * -0.5;
	groundCollider.cursor = new THREE.Vector3();
	var camPanDelta = new THREE.Vector3();
	groundCollider.getColliders = function() {
		return [groundCollider];
	}
	groundCollider.onOver = function(){
		console.log('ground collider on Over!');
	}
	groundCollider.onStart = function(pos){
		this.cursor.copy(pos);
		console.log('ground collider on Start!');
	}
	groundCollider.onDrag = function(pos){
		if(!pos) return;
		camPanDelta.sub(pos);
		camPanDelta.add(this.cursor);
		this.cursor.copy(pos);
		console.log('ground collider on Drag!');
	}
	groundCollider.onEnd = function(){
		console.log('ground collider on End!');
	}
	groundCollider.onOut = function(){
		console.log('ground collider on Out!');
	}
	groundCollider.onSelect = function(){
		console.log('ground collider on Select!');
	}
	groundCollider.collisionOwner = groundCollider;
	scene.add(groundCollider);

	var test = new CarvableTetrahedron({
		material: material
	});
	test.castShadow = true;
	test.receiveShadow = true;

	test.position.set(1.5, 1.5, -2);
	scene.add(test);
	var sky = new Sky({
		scene: scene,
		renderer: renderer,
		mapPath: 'assets/textures/sky-sun-stars-day-cycle.png'
	});

	var cameraFirstPerson = new FirstPersonCamera({
		rayEvents: rayEvents
	});

	var cameraThirdPerson = new ThirdPersonCamera();
	scene.add(cameraThirdPerson);

	var _this = this;
	this.rayLauncherClass = MagicWindowRayLauncher;
	function onVRChangeCameraAndRayLauncher(state) {
		var camRoot = app.camera;
		if(camRoot && camRoot.anchor) camRoot = camRoot.anchor;
		if(camRoot && camRoot.parent) {
			camRoot.parent.remove(camRoot);
		}
		if(state) {
			app.camera = cameraFirstPerson;
			cameraFirstPerson.anchor.position.x = fireLight.position.x;
			cameraFirstPerson.anchor.position.z = fireLight.position.z;
			_this.rayLauncherClass = CardboardRayLauncher;
			scene.add(cameraFirstPerson.anchor);
		} else {
			app.camera = cameraThirdPerson;
			_this.rayLauncherClass = MagicWindowRayLauncher;
			scene.add(cameraThirdPerson);
		}
	}
	onVR(onVRChangeCameraAndRayLauncher);


	function onDayDreamChangeRayLauncher(state) {
		if(state) {
			_this.rayLauncherClass = DayDreamRayLauncher;
		} else {
			_this.rayLauncherClass = CardboardRayLauncher;
		}
	}


	var fireLight = new FireLight();
	scene.add(fireLight);
	fireLight.position.set(0, 0.5, 0);

	renderer.shadowMap.enabled = true;
	renderer.shadowMap.type = THREE.PCFShadowMap;

	this.scene = scene;
	this.sky = sky;
	this.fireLight = fireLight;
	this.camPanDelta = camPanDelta;
	this.test = test;
	this.cameraFirstPerson = cameraFirstPerson;
	this.cameraThirdPerson = cameraThirdPerson;
	this.groundCollider = groundCollider;
	this.app = app;
}

function _switchRayLauncher(classRef) {
	switch(classRef) {
		case MagicWindowRayLauncher:
			return new classRef(this.cameraThirdPerson);
		case CardboardRayLauncher:
			return new classRef(this.cameraFirstPerson);
		case DayDreamRayLauncher:
			return new classRef(this.cameraFirstPerson.getDayDreamController());
		default:
			return null;
	}
}

function onEnterFrame(dt) {	if((this.scene.rayLauncher && !this.rayLauncherClass) || (this.rayLauncherClass && !(this.scene.rayLauncher instanceof this.rayLauncherClass))) {
		this.scene.rayLauncher = _switchRayLauncher.call(this, this.rayLauncherClass);
	}
	this.dynamicTextureManager.update();
	this.sky.update();
	this.test.rotation.y = performance.now() * 0.0001;
	this.cameraThirdPerson.position.add(this.camPanDelta);
	this.fireLight.position.add(this.camPanDelta);
	this.groundCollider.cursor.add(this.camPanDelta);
	this.camPanDelta.set(0, 0, 0);
	this.sky.moveTo(this.app.camera.position);
}

function onResize(w, h) {
	this.cameraFirstPerson.onResize(w, h);
	this.cameraThirdPerson.onResize(w, h);
}

GameWorld.prototype = {
	onEnterFrame: onEnterFrame,
	onResize: onResize
}

module.exports = GameWorld;
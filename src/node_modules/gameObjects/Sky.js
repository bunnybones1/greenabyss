var THREE = require('three');
var defaults = require('lodash.defaults');
var SkySampler = require('utils/SkySampler');
var SpriteSky = require('./SpriteSky');
var SpriteSun = require('./SpriteSun');
var Stars = require('./Stars');
var eases = require('eases');

var __defaultParams = {
	skyColor: 0xafbfef,
	groundColor: 0x4f3f2f,
	dayOnly: false,
	pointScale: 2000,
	radius: 80
};


function Sky(params) {
	params = defaults(params, __defaultParams);
	if(!params.scene) throw new Error('Provide a scene');
	if(!params.renderer) throw new Error('Provide a renderer');
	var scene = params.scene;
	var skyColor = new THREE.Color(params.skyColor);
	var groundColor = new THREE.Color(params.groundColor);
	this.originalGroundColor = groundColor.clone();
	var ambientLight = new THREE.HemisphereLight(skyColor, groundColor);
	skyColor = ambientLight.color;
	groundColor = ambientLight.groundColor;
	scene.add(ambientLight);
	var sunLight = new THREE.DirectionalLight(0xffffaf, 0.75);
	sunLight.position.set( 0, 100, 100 );
	sunLight.target.position.set( 0, 0, 0 );

	// var sky = new THREE.Sky(80);
	// sky.uniforms.sunPosition.value = sunLight.position;
	// scene.add(sky.mesh);
	var skySpriteMap = THREE.ImageUtils.loadTexture('assets/textures/sky-sun-stars-day-cycle.png');
	skySpriteMap.generateMipmaps = false;
	skySpriteMap.magFilter = THREE.LinearFilter;
	skySpriteMap.minFilter = THREE.LinearFilter;

	// var skySpriteMap = THREE.ImageUtils.loadTexture('assets/textures/sky-day-cycle.png');
	// var skySpriteMap = THREE.ImageUtils.loadTexture('assets/textures/uvTest.png');
	var sky = new SpriteSky({
		mapTexture: skySpriteMap,
		mapFrameHeight: 6,
		mapFrames: 48, 
		mapTotalHeight: 512, 
		radius: params.radius
	});		
	scene.add(sky);

	var stars = new Stars({
		mapTexture: skySpriteMap,
		mapFrameHeight: 6,
		mapFrames: 48, 
		mapTotalHeight: 512, 
		total: 20000,
		pointScale: params.pointScale,
		radius: params.radius
	});
	stars.rotation.x = Math.PI * 0.66;
	stars.rotation.order = "ZYX";
	scene.add(stars);

	var sun = new SpriteSun({
		mapTexture: skySpriteMap,
		mapFrameHeight: 6,
		mapFrames: 48, 
		mapTotalHeight: 512, 
		radius: params.radius
	});
	// sun.rotation.x = Math.PI * 1.5;
	scene.add(sun);

	var skySampler = new SkySampler({
		renderer: params.renderer,
		sunPosition: sunLight.position
	});

	skySampler.createSample(new THREE.Vector3(100, 100, 100), skyColor);
	skySampler.createSample(sunLight.position, sunLight.color);

	sunLight.castShadow = true;
	scene.add(sunLight);

	this.sunLight = sunLight;
	this.sky = sky;
	this.sun = sun;
	this.stars = stars;
	this.skyColor = skyColor;
	this.groundColor = groundColor;
	this.skySampler = skySampler;
	this.dayOnly = params.dayOnly;
}

Sky.prototype.update = function() {
	var speed = 0.0000015;
	var dayPercent = Date.now() * speed;
	var daysPerYear = 365;
	var yearPercent = Date.now() * speed / daysPerYear;
	// dayPercent = 1-0.45;
	// dayPercent = 0.49;
	var angle = dayPercent * Math.PI * 2;
	if(this.dayOnly) {
		if((angle % (Math.PI * 2)) > Math.PI) {
			angle -= Math.PI;
		}
	}
	this.sun.rotation.z = angle + Math.PI * -0.5;
	var skyProgressLinear = dayPercent + 0.25;
	var skyProgress = skyProgressLinear + Math.sin(dayPercent * Math.PI * 2 * 2) / 16;
	this.sky.material.progress = skyProgress;
	this.sun.material.progress = skyProgress;
	this.stars.material.progress = skyProgress;
	this.stars.rotation.z = (dayPercent + yearPercent) * Math.PI * 2;

	this.sunLight.position.set(
		Math.cos(angle) * 90,
		Math.sin(angle) * 90,
		0
	);
	this.skySampler.update();
	if((angle % (Math.PI * 2)) > Math.PI) {
		this.skyColor.setRGB(0.15, 0.3, 0.5);
		var intensity = 1.0 - Math.pow(1.0 - Math.sin(angle % Math.PI), 2);
		this.skyColor.multiplyScalar(intensity);
		this.groundColor.setRGB(0.15, 0.3, 0.3);
		this.groundColor.multiplyScalar(intensity);
	} else {
		this.groundColor.copy(this.originalGroundColor);
	}
}

Sky.prototype.moveTo = function(pos) {
	this.sky.position.copy(pos);
	this.sun.position.copy(pos);
	this.stars.position.copy(pos);
}

module.exports = Sky;